#!/bin/sh
: <<-'header'
  <main>
    <h1>Apollo CLI Install Script</h1>
    This is the install script for the Apollo command line tools.

    To run it, copy the command below and run it in your terminal:
    <div id=tip> </div>
    <code id=cmd>curl -sSL https://install.apollographql.com | sh</code>


    Or if you prefer, you can copy the code right out of this page.
    

    happy graphing!

    <img src=telescope.svg>
          ~ xoxo,
          the apollo team
  </main>  

  <pre><code class=bash>
end of
header


set -o errexit

# GitHub's URL for the latest release, will redirect.
DESTDIR="${DESTDIR:-/usr/local/bin}"
INSTALL_PATH="${DESTDIR}/apollo"

error_exit() {
	echo "$1" 1>&2
	exit 1
}

check_environment_readiness() {
  if [ -z "$(command -v curl)" ]; then
    echo "The curl command is not installed on this machine. Please install curl before installing the Apollo CLI"
    return 1
  fi

  if [ -z "$(command -v tar)" ]; then
    echo "The tar command is not installed on this machine. Please install tar before installing the Apollo CLI"
    return 1
  fi

  if ! [ -d "$DESTDIR" ]; then
    echo "Attempting to install the Apollo CLI in $DESTDIR but that directory wasn't found on your filesystem. Please create a directory by using mkdir $DESTDIR or specify a DESTDIR variable when running the installer"
    return 1
  fi

  if ! [ -w "$DESTDIR" ]; then
    echo "Attempting to install the Apollo CLI in $DESTDIR but the permissions deny writing to that directory."
    return 1
  fi

  EXISTING_APOLLO="$(command -v apollo)"
  if [ -n "$EXISTING_APOLLO" ]; then
    echo "An existing version of 'apollo' is already installed at $EXISTING_APOLLO. If you want the latest version, please uninstall the old one first then run this again."
    return 1
  fi

  return
}

download_and_install() {
  # Determine release filename. This can be expanded with CPU arch in the future.
  if [ "$(uname)" = "Linux" ]; then
    OS="linux"
  elif [ "$(uname)" = "Darwin" ]; then
    OS="darwin"
  else
    echo "This operating system ('$(uname)') is not supported."
    return 1
  fi

  download_from_proxy || fallback_and_download_from_github

  if ! [ -e "./apollo" ] ; then
    echo "After installing the CLI tarball we were unable to find the apollo binary"
    return 1
  fi

  mv apollo "$DESTDIR"
  chmod +x "$INSTALL_PATH"

  command -v apollo

  return
}

download_from_proxy() {
  RELEASE_URL="https://install.apollographql.workers.dev/cli/${OS}/${VERSION}"
  # Download & unpack the release tarball.
  curl -sL --retry 3 "${RELEASE_URL}" | tar zx --strip 1
}

fallback_and_download_from_github() {
  
  echo "Could not install from the Apollo CDN, falling back to GitHub installation"

  if [ -z "$(command -v cut)" ]; then
    echo "The cut command is not installed on this machine. Please install cut before installing the Apollo CLI"
    return 1
  fi

  # GitHub's URL for the latest release, will redirect.
  LATEST_URL="https://github.com/apollographql/apollo-cli/releases/latest/"
  if [ -z "$VERSION" ]; then
    VERSION=$(curl -sLI -o /dev/null -w '%{url_effective}' $LATEST_URL | cut -d "v" -f 2)
  fi

  RELEASE_URL="https://github.com/apollographql/apollo-cli/releases/download/v${VERSION}/apollo-v${VERSION}-x86_64-${OS}.tar.gz"

  # Download & unpack the release tarball.
  curl -sL --retry 3 "${RELEASE_URL}" | tar zx --strip 1
}

run_main() {
  echo "Installing Apollo CLI..."

  check_environment_readiness || error_exit "Environment setup failed!"

   # Run the script in a temporary directory that we know is empty.
  SCRATCH="$(mktemp -d || mktemp -d -t 'tmp')"
  cd "$SCRATCH"

  download_and_install || error_exit "An error occured installing the tool. The contents of the directory $SCRATCH have been left in place to help to debug the issue."

  # Delete the working directory when the install was successful.
  rm -r "$SCRATCH"

  echo "Apollo CLI was successfully installed!"

  return
}

# if we aren't in our testing framework, run the main installer
if [ -z $BATS_RUNNING ] ; then
  run_main
fi

: <<-'the end.'
  </code></pre>
  <link rel=stylesheet
  href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/atelier-sulphurpool-dark.min.css>

  <style>    
  body, code {
    font-family: 'Source Sans Pro', 'Menlo', 'Courier', monospace;
    white-space: pre;
    background: rgb(26, 18, 59) !important;
    color: #FFFAE6;
  }

  main {
    display: table;
    margin: auto;
  }

  h1 {
    text-align: center;
  }

  #cmd {
    display: table;
    margin: auto;
    font-size: 14pt;
    text-align: center;
    cursor: pointer;
    padding: 0.4em;
    color: #FFE88E;
    border: thin solid rgba(255, 0, 255, 0);
  }

  #cmd:hover {
    border: thin solid fuchsia;
    animation: alternate pulse 2s linear infinite;
  }

  #cmd::selection {
    background: fuchsia;
  }

  #tip {
    text-align: center;
    color: fuchsia;
    margin-bottom: 1em;
  }

  @keyframes pulse {
    0% { border-color: rgba(255, 0, 255, 0); }
    50%, 100% {
      border-color: rgba(255, 0, 255, 1);
    }
  }

  </style>
  <script>
  cmd.onmouseover = () => say('click to copy')
  cmd.onmouseout = () => say(' ')
  cmd.onclick = () => {
    getSelection().selectAllChildren(cmd)
    document.execCommand('copy')
    say('ok, copied', 2000)
  }

  function say(msg, dur) {
    tip.textContent = msg
    Number.isFinite(dur) && setTimeout(() => say(' '), dur)
  }
  </script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>
  <script>hljs.initHighlighting()</script>
the end.